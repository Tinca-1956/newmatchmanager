
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get user's role from their user document
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Helper function to get user's primary club ID
    function getPrimaryClubId(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.primaryClubId;
    }
    
    // Helper function to check if a user is a Site Admin
    function isSiteAdmin(userId) {
      return getUserRole(userId) == 'Site Admin';
    }

    // Helper function to check if a user is a Club Admin for a specific club
    function isClubAdmin(userId, clubId) {
      return getUserRole(userId) == 'Club Admin' && getPrimaryClubId(userId) == clubId;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Allow users to read their own profile
      // Allow Site Admins to read any profile
      // Allow Club Admins to read profiles of users in their club
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        isSiteAdmin(request.auth.uid) ||
        isClubAdmin(request.auth.uid, resource.data.primaryClubId)
      );

      // Allow users to update their own profile (firstName, lastName, primaryClubId)
      // Allow Site Admins to update any profile
      // Allow Club Admins to update profiles of users in their club
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        isSiteAdmin(request.auth.uid) ||
        isClubAdmin(request.auth.uid, resource.data.primaryClubId)
      );
      
      // Only Site Admins can delete user documents
      allow delete: if request.auth != null && isSiteAdmin(request.auth.uid);
      
      // Anyone authenticated can create their own user document
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for the 'clubs' collection
    match /clubs/{clubId} {
      // Any authenticated user can read club details
      allow read: if request.auth != null;
      
      // Only Site Admins can create or delete clubs
      allow create, delete: if request.auth != null && isSiteAdmin(request.auth.uid);

      // Site Admins and Club Admins of that specific club can update it
      allow update: if request.auth != null && (
        isSiteAdmin(request.auth.uid) ||
        isClubAdmin(request.auth.uid, clubId)
      );
    }

    // Rules for 'series', 'matches', and 'results' follow a similar pattern
    match /{collection}/{docId} {
       // Allow anyone to read public collections
      allow read: if collection == 'publicMatches' || collection == 'publicUpcomingMatches';
      
      // Authenticated users can read private data if they belong to the club
      allow read: if request.auth != null && (
        isSiteAdmin(request.auth.uid) ||
        isClubAdmin(request.auth.uid, resource.data.clubId) ||
        getPrimaryClubId(request.auth.uid) == resource.data.clubId
      );

      // Only Admins can create/update/delete these documents
      allow write: if request.auth != null && (
        isSiteAdmin(request.auth.uid) ||
        isClubAdmin(request.auth.uid, resource.data.clubId)
      );
    }
  }
}
