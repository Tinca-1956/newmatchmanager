rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSiteAdmin() {
      return isSignedIn() && getUserData().role == 'Site Admin';
    }

    function isClubAdmin() {
      return isSignedIn() && (getUserData().role == 'Club Admin' || getUserData().role == 'Site Admin');
    }

    match /users/{userId} {
      // Allow users to read their own data
      allow get: if isSignedIn() && request.auth.uid == userId;
      
      // Allow users to create their own record, and update their own firstName, lastName, and primaryClubId.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['firstName', 'lastName', 'primaryClubId']);
      
      // Allow admins to update other users' roles and status.
      allow update: if isClubAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasAny(['firstName', 'lastName', 'role', 'memberStatus']);

      // Allow admins to list all users belonging to their club.
      allow list: if isClubAdmin() && request.query.where.to_list()[0].value == getUserData().primaryClubId;
    }

    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow create, update: if isClubAdmin();
      allow delete: if isSiteAdmin();
    }

    match /series/{seriesId} {
      // User can read series for their own club
      allow read: if isSignedIn() && getUserData().primaryClubId == resource.data.clubId;
      // Admins can write to series in their own club
      allow write: if isClubAdmin() && getUserData().primaryClubId == request.resource.data.clubId;
    }

    match /matches/{matchId} {
      // User can read matches for their own club
      allow read: if isSignedIn() && getUserData().primaryClubId == resource.data.clubId;
      // Admins can write to matches in their own club
      allow write: if isClubAdmin() && getUserData().primaryClubId == request.resource.data.clubId;
    }
  }
}
