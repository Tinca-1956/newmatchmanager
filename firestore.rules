rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isSiteAdmin() {
      return request.auth.token.role == 'Site Admin';
    }

    function isClubAdmin(clubId) {
      // An admin of a specific club
      return request.auth.token.role == 'Club Admin' 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == clubId;
    }
    
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isProfileOwner(userId) {
      return request.auth.uid == userId;
    }

    // =================================
    // Collection Rules
    // =================================
    match /users/{userId} {
      // READ: Site Admins can read any user. Authenticated users can read profiles within their own primary club. Users can always read their own profile.
      allow read: if isSiteAdmin() || isProfileOwner(userId) || (isUserAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == resource.data.primaryClubId);
      
      // LIST: Site Admins can list all users. Club Admins/Members can list users from their own club.
      allow list: if isUserAuthenticated();

      // WRITE: Users can create their own profile. Site Admins and authorized Club Admins can update profiles.
      allow create: if isUserAuthenticated();
      allow update: if isSiteAdmin() || isProfileOwner(userId) || isClubAdmin(resource.data.primaryClubId);
      allow delete: if isSiteAdmin();
    }

    match /clubs/{clubId} {
      // All authenticated users can read club information.
      allow read: if isUserAuthenticated();
      // Only Site Admins can create, update, or delete clubs.
      allow write: if isSiteAdmin();
    }

    match /series/{seriesId} {
      // READ: Site Admins or any member of the club can read series info.
      allow read: if isSiteAdmin() || (isUserAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == resource.data.clubId);
      
      // WRITE: Only Site Admins or Club Admins of that club can write.
      allow write: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId);
    }
    
    match /matches/{matchId} {
        // READ: Site Admins or any member of the club can read match info.
        allow read: if isSiteAdmin() || (isUserAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == resource.data.clubId);
        
        // WRITE: Only admins of that club can write/update. Any authenticated user can register (update registeredAnglers array).
        allow create, delete: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId);
        allow update: if isSiteAdmin() || isClubAdmin(resource.data.clubId) || isUserAuthenticated();
    }
    
    match /results/{resultId} {
        // READ: Site Admins or any member of the club can read results.
        allow read: if isSiteAdmin() || (isUserAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == resource.data.clubId);
        
        // WRITE: Only admins or marshals can write results.
        allow write: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId) || request.auth.token.role == 'Marshal';
    }

    match /applications/{appId} {
        // READ: A Site Admin, or an Admin of the club being applied to.
        allow read: if isSiteAdmin() || isClubAdmin(resource.data.clubId);

        // LIST: A Site Admin, or an Admin of the club being applied to.
        allow list: if isSiteAdmin() || isClubAdmin(request.query.clubId);

        // CREATE: Any authenticated user can create an application for themselves.
        allow create: if isUserAuthenticated() && request.auth.uid == request.resource.data.userId;

        // DELETE: Only admins of that club can delete (i.e., process) an application.
        allow delete: if isSiteAdmin() || isClubAdmin(resource.data.clubId);
    }

    match /memberships/{membershipId} {
        // READ: The user themself, a Site Admin, or an Admin of that club can read.
        allow read: if isProfileOwner(resource.data.userId) || isSiteAdmin() || isClubAdmin(resource.data.clubId);
        
        // WRITE: Site Admin or Club Admin of that club.
        allow write: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId);
    }
  }
}
