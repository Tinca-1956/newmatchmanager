
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Any authenticated user can read their own document or update their own name/club.
      // Other updates (role, status) are handled by backend logic/admins.
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // TEMPORARY FIX: Allow any authenticated user to list all users.
      // This is to unblock the members page. We can refine this later.
      allow list: if request.auth != null;
    }

    match /clubs/{clubId} {
      // All authenticated users can read club information.
      allow read: if request.auth != null;
      // Only site admins can create/update/delete clubs.
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Site Admin';
    }

    match /series/{seriesId} {
       // All authenticated users can read series information.
      allow read: if request.auth != null;
      // Only admins/marshals of that club can write.
      allow write: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Site Admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Club Admin');
    }
    
    match /matches/{matchId} {
       // All authenticated users can read match information.
      allow read: if request.auth != null;
       // Only admins/marshals of that club can write.
      allow write: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Site Admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Club Admin');
    }

    match /results/{resultId} {
       // All authenticated users can read results.
      allow read: if request.auth != null;
       // Only admins/marshals of that club can write.
      allow write: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Site Admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Club Admin');
    }
  }
}
