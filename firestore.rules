rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isUserAuthenticated() {
      return request.auth != null;
    }
    
    function isSiteAdmin(userId) {
      return getUserData(userId).role == 'Site Admin';
    }

    function isClubAdmin(userId, clubId) {
      let userData = getUserData(userId);
      return userData.role == 'Club Admin' && userData.primaryClubId == clubId;
    }
    
    // /users/{userId}
    match /users/{userId} {
      // Allow users to read their own data.
      // Admins can read any user's data.
      allow read: if isUserAuthenticated() && (request.auth.uid == userId || isSiteAdmin(request.auth.uid));
      
      // Allow users to create their own profile.
      allow create: if isUserAuthenticated() && request.auth.uid == userId;

      // Allow users to update their own data.
      // Admins can update any user's data.
      allow update: if isUserAuthenticated() && (request.auth.uid == userId || isSiteAdmin(request.auth.uid));
      
      // Only Site Admins can delete user documents.
      allow delete: if isUserAuthenticated() && isSiteAdmin(request.auth.uid);
    }
    
    // /clubs/{clubId}
    match /clubs/{clubId} {
        // Any authenticated user can read club information.
        allow read: if isUserAuthenticated();
        
        // Only Site Admins can create, update, or delete clubs.
        allow write: if isUserAuthenticated() && isSiteAdmin(request.auth.uid);
    }

    // /series/{seriesId}
    match /series/{seriesId} {
        // Any authenticated user can read series information.
        allow read: if isUserAuthenticated();
        
        // Only Site Admins or a Club Admin for that specific club can write.
        allow write: if isUserAuthenticated() && 
                      (isSiteAdmin(request.auth.uid) || isClubAdmin(request.auth.uid, request.resource.data.clubId));
    }
    
    // /matches/{matchId}
    match /matches/{matchId} {
        // Any authenticated user can read match information.
        allow read: if isUserAuthenticated();
        
        // Admins and club admins can create, update, and delete matches.
        allow write: if isUserAuthenticated() && 
                      (isSiteAdmin(request.auth.uid) || isClubAdmin(request.auth.uid, request.resource.data.clubId));
    }

    // /results/{resultId}
    match /results/{resultId} {
        // Any authenticated user can read results.
        allow read: if isUserAuthenticated();
        
        // Only admins or club admins of the relevant club can write results.
        allow write: if isUserAuthenticated() &&
                      (isSiteAdmin(request.auth.uid) || isClubAdmin(request.auth.uid, request.resource.data.clubId));
    }
  }
}
