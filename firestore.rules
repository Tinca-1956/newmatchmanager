rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow public read access for the dashboard filter.
    // Write access is still restricted.
    match /clubs/{clubId} {
      allow read: if true;
      // Only site admins can create, update, or delete clubs
      allow write: if request.auth.token.email == 'stuart.thomas.winton@gmail.com';
    }

    // Allow public read access to published match results
    match /publicMatches/{matchId} {
      allow read: if true;
      allow write: if false; // Should only be written from a trusted backend/admin
    }

    // Allow public read access to upcoming matches
    match /publicUpcomingMatches/{matchId} {
      allow read: if true;
      allow write: if false; // Should only be written from a trusted backend/admin
    }

    match /users/{userId} {
      // Users can only read/write their own document
      allow read, write: if request.auth.uid == userId;
    }

    match /matches/{matchId} {
        // Any signed-in user can read any match
        allow read: if isSignedIn();
        // Only admins of the club can create/update/delete matches
        allow write: if isClubAdmin(get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.id);
    }
    
    match /results/{resultId} {
        allow read: if isSignedIn();
        // Only admins can write results
        allow write: if isClubAdmin(get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.id);
    }
    
     match /series/{seriesId} {
        allow read: if isSignedIn();
        // Only admins can write series
        allow write: if isClubAdmin(get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.id);
    }

    match /helpDocuments/{documentId} {
      allow read: if true;
      allow write: if request.auth.token.email == 'stuart.thomas.winton@gmail.com';
    }
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isClubAdmin(clubId) {
        let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        let userPrimaryClubId = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId;
        
        // Site Admin has universal club admin rights
        if (userRole == 'Site Admin') {
            return true;
        }
        
        // Club admin must be admin of the specific club
        return userRole == 'Club Admin' && userPrimaryClubId == clubId;
    }
  }
}