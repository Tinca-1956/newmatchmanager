rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isOneOfRoles(roles) {
      return isSignedIn() && getRole() in roles;
    }
    
    function isSiteAdmin() {
        return isSignedIn() && getRole() == 'Site Admin';
    }

    // Rules for 'users' collection
    match /users/{userId} {
      allow read: if isSiteAdmin() || isUser(userId);
      allow write: if isSiteAdmin() || isUser(userId);
      allow list: if isSiteAdmin();
    }

    // Rules for 'clubs' collection
    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow write: if isSiteAdmin();
      allow list: if isSignedIn();
    }
    
    // Rules for 'series' collection
    match /series/{seriesId} {
        allow read: if isSignedIn();
        allow create, update: if isOneOfRoles(['Site Admin', 'Club Admin']);
        allow delete: if isSiteAdmin();
        allow list: if isSignedIn();
    }
    
    // Rules for 'results' collection
    match /results/{resultId} {
        allow read: if isSignedIn();
        allow create, update: if isOneOfRoles(['Site Admin', 'Club Admin', 'Marshal']);
        allow delete: if isSiteAdmin();
    }

    // Rules for 'matches' collection
    match /matches/{matchId} {
      // Allow any signed-in user to get a single match document.
      allow get: if isSignedIn();

      // Allow users to list matches if they are a Site Admin, OR if the query they are making
      // is for their own specific clubId.
      allow list: if isSiteAdmin() || (
        isSignedIn() && request.query.where.clubId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId
      );
      
      // Allow create, update, delete for Admins
      allow create, update, delete: if isOneOfRoles(['Site Admin', 'Club Admin']);
    }
  }
}
