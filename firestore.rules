rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // UTILITY FUNCTIONS
    function isAuth() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function userRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function userClubId() {
       return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId;
    }
    
    function isSiteAdmin() {
      return isAuth() && userRole() == 'Site Admin';
    }
    
    function isClubAdmin() {
      return isAuth() && userRole() == 'Club Admin';
    }

    // CLUBS
    match /clubs/{clubId} {
      // ANYONE can view the list of clubs
      allow read;
      
      // ONLY Site Admins can create or delete clubs
      allow create, delete: if isSiteAdmin();
      
      // Club Admins can update their own club, Site Admins can update any
      allow update: if isSiteAdmin() || (isClubAdmin() && userClubId() == clubId);
    }

    // USERS
    match /users/{userId} {
      // A user can create their own profile document, but only if it doesn't exist yet
      // This is for the initial sign-up flow after email verification.
      allow create: if isUser(userId) && !exists(/databases/$(database)/documents/users/$(userId));

      // A user can read their own profile. Admins can read any user profile in their club.
      allow read: if isUser(userId) || (isClubAdmin() && resource.data.primaryClubId == userClubId()) || isSiteAdmin();
      
      // A user can update their own profile. Admins can update any user in their club.
      allow update: if isUser(userId) || (isClubAdmin() && resource.data.primaryClubId == userClubId()) || isSiteAdmin();
      
      // Only Site Admins can delete user documents.
      allow delete: if isSiteAdmin();
      
      // Club Admins or Site Admins can list users within a club.
      allow list: if isClubAdmin() || isSiteAdmin();
    }
    
    // SERIES
    match /series/{seriesId} {
        // Any authenticated user can read series data. The UI filters by club.
        allow read, list: if isAuth();
        
        // Admins can create, update, or delete series documents.
        allow write: if isClubAdmin() || isSiteAdmin();
    }
    
    // MATCHES
    match /matches/{matchId} {
      // Authenticated users can list matches. The UI filters by club.
      // The `read` rule below provides the document-level security.
      allow list: if isAuth();

      // Any user can read a match document if they belong to the same club.
      allow read: if isAuth() && resource.data.clubId == userClubId() || isSiteAdmin();
      
      // Club Admins or Site Admins can create, update, or delete match documents.
      allow write: if isClubAdmin() || isSiteAdmin();
    }
    
    // RESULTS
    match /results/{resultId} {
      // Any authenticated user can list/read results.
      // This is required for the public-facing results page and for users to see their own results.
      allow read, list: if isAuth();
      
      // Only Admins or Marshals can write to results.
      // (This rule may need to be expanded if you allow users to submit their own results later)
      allow write: if isClubAdmin() || isSiteAdmin();
    }

    // HELP DOCUMENTS
    match /helpDocuments/{docId} {
        // Any authenticated user can read help docs.
        allow read, list: if isAuth();
        // Only a site admin can write or delete help docs.
        allow write: if isSiteAdmin();
    }

    // PUBLIC COLLECTIONS
    match /publicUpcomingMatches/{matchId} {
      // Anyone, even unauthenticated users, can read the public upcoming matches.
      allow get, list: if true;
      // Only admins can write (this is typically done via a function or admin action).
      allow write: if isSiteAdmin() || isClubAdmin();
    }

    match /publicMatches/{matchId} {
      // Anyone can read published match results.
      allow get, list: if true;
       // Only admins can write.
      allow write: if isSiteAdmin() || isClubAdmin();
    }
  }
}