rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles from the user's own document
    function isSiteAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Site Admin';
    }

    function isClubAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Club Admin';
    }

    function isAngler() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Angler';
    }

    // --- USERS ---
    // Admins can read/write all user profiles.
    // Any authenticated user can read their OWN user document.
    // Any authenticated user can update their OWN user document.
    match /users/{userId} {
      allow read, write: if request.auth != null && (isSiteAdmin() || isClubAdmin());
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // --- CLUBS ---
    // Any authenticated user can read the list of clubs.
    // Only site admins can create, update, or delete clubs.
    match /clubs/{clubId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSiteAdmin();
    }
    
    // --- SERIES ---
    // Authenticated users can read series information.
    // Admins can write/edit series information.
    match /series/{seriesId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (isSiteAdmin() || isClubAdmin());
    }

    // --- MATCHES ---
    // Any authenticated user can read match data.
    // An angler can register for a match (add their UID to the registeredAnglers array).
    // Admins can create, update, or delete matches.
    match /matches/{matchId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && (isSiteAdmin() || isClubAdmin());
      allow update: if request.auth != null && isAngler()
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registeredAnglers', 'registeredCount']);
    }

    // --- RESULTS ---
    // Results can be read by any authenticated user.
    // Results can only be written by admins.
    match /results/{resultId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (isSiteAdmin() || isClubAdmin());
    }
  }
}
