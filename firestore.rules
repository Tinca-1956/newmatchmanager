
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Combine user rules into a single block
    match /users/{userId} {
      // Allow users to read/write their own document
      allow update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
      
      // Allow a user to read another user's document if they are in the same club
      // Also allow a user to read their own document
      allow read: if (request.auth.uid == userId) || 
                  (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.primaryClubId == resource.data.primaryClubId);
    }

    // Rules for other collections
    match /clubs/{clubId} {
      allow read: if true;
      allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Site Admin'];
    }
    
    match /series/{seriesId} {
      allow read: if true;
      allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Site Admin', 'Club Admin'];
    }

    match /matches/{matchId} {
      allow read: if true;
      allow create, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Site Admin', 'Club Admin'];
    }

    match /results/{resultId} {
      allow read: if true;
      // Marshals, Club Admins, and Site Admins can write to results
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['Site Admin', 'Club Admin', 'Marshal'];
    }
  }
}
