rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper Functions
    function isSiteAdmin() {
      return request.auth.token.role == 'Site Admin';
    }

    function isClubAdmin(clubId) {
      // Check if the user has a 'Club Admin' role in their profile
      // for the specific clubId being requested.
      let userProfile = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userProfile.role == 'Club Admin' && userProfile.primaryClubId == clubId;
    }
    
    // Authenticated users can read their own profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      // Admins can read/write any user profile.
      allow read, write: if isSiteAdmin() || isClubAdmin(resource.data.primaryClubId);
    }
    
    // Public read for clubs, write access for Site Admins
    match /clubs/{clubId} {
      allow read: if request.auth.uid != null;
      allow write: if isSiteAdmin();
    }
    
    // Only Site Admins or Club Admins of the relevant club can write
    match /series/{seriesId} {
        allow read: if request.auth.uid != null;
        allow write: if isSiteAdmin() || isClubAdmin(resource.data.clubId);
    }

    match /matches/{matchId} {
        // Any authenticated user can read match details.
        allow read: if request.auth.uid != null;

        // Allow creating/updating matches only for Site/Club Admins of that club.
        // Also allow any authenticated user to update the 'registeredAnglers' and 'registeredCount'
        // fields when they register themselves for a match.
        allow write: if isSiteAdmin() || 
                       isClubAdmin(request.resource.data.clubId) ||
                       (request.auth.uid != null && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registeredAnglers', 'registeredCount']));
    }

    match /results/{resultId} {
      allow read: if request.auth.uid != null;
      // Allow writing results only for admins/marshals of that club
      allow write: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId); 
    }
    
    match /applications/{applicationId} {
        // Allow creating an application for any authenticated user.
        allow create: if request.auth.uid == request.resource.data.userId;
        
        // Allow reading/deleting applications only for admins of that club.
        allow read, delete: if isSiteAdmin() || isClubAdmin(resource.data.clubId);
    }
    
     match /memberships/{membershipId} {
        allow create: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId);
        allow read: if request.auth.uid != null;
    }

  }
}