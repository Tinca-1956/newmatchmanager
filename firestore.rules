rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get a user's role from their profile
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Helper function to get a user's primary club from their profile
    function getUserPrimaryClub(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.primaryClubId;
    }
    
    // Site admins can do anything
    function isSiteAdmin(userId) {
      return getUserRole(userId) == 'Site Admin';
    }
    
    // Club admins can do anything as long as it's for their own club
    function isClubAdmin(userId, clubId) {
      return getUserRole(userId) == 'Club Admin' && getUserPrimaryClub(userId) == clubId;
    }

    match /users/{userId} {
      // Users can read their own profile.
      // Admins can read any user profile.
      allow read: if request.auth.uid == userId || isSiteAdmin(request.auth.uid);
      
      // Users can update their own profile.
      // Admins can update any user profile.
      allow write: if request.auth.uid == userId || isSiteAdmin(request.auth.uid);
    }

    match /clubs/{clubId} {
      // Any authenticated user can read club information
      allow read: if request.auth != null;
      // Only site admins can create, update, or delete clubs
      allow write: if isSiteAdmin(request.auth.uid);
    }
    
    match /series/{seriesId} {
        // Any authenticated user can read series information.
        allow read: if request.auth != null;

        // Writing (create, update, delete) is restricted.
        // A user can write to a series document if they are a Site Admin,
        // OR if they are a Club Admin for the club that owns this series.
        allow write: if isSiteAdmin(request.auth.uid) || 
                      isClubAdmin(request.auth.uid, resource.data.clubId);
    }

    match /matches/{matchId} {
        // Any authenticated user can read a single match document.
        allow read: if request.auth != null;
        
        // A user can list matches if the query's clubId matches their own primaryClubId,
        // OR if they are a Site Admin who can list matches for any club.
        allow list: if request.query.clubId == getUserPrimaryClub(request.auth.uid) || isSiteAdmin(request.auth.uid);

        // Writing (create, update, delete) to a match is restricted.
        // A user can write to a match document if they are a Site Admin,
        // OR if they are a Club Admin for the club that owns this match.
        allow write: if isSiteAdmin(request.auth.uid) ||
                      isClubAdmin(request.auth.uid, resource.data.clubId);
    }

    match /results/{resultId} {
        // Any authenticated user can read results.
        allow read: if request.auth != null;

        // Writing results is restricted.
        // A user can write to a result if they are a Site Admin,
        // a Club Admin for the club that owns the result,
        // or a Marshal.
        allow write: if isSiteAdmin(request.auth.uid) ||
                      isClubAdmin(request.auth.uid, resource.data.clubId) ||
                      getUserRole(request.auth.uid) == 'Marshal';
    }
  }
}
