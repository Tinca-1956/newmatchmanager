rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if a user is an admin of a specific club
    function isClubAdmin(userId, clubId) {
      let userDoc = get(/databases/(default)/documents/users/$(userId));
      return userDoc.data.primaryClubId == clubId &&
             (userDoc.data.role == 'Club Admin' || userDoc.data.role == 'Site Admin');
    }
    
     function isSiteAdmin(userId) {
      let userDoc = get(/databases/(default)/documents/users/$(userId));
      return userDoc.data.role == 'Site Admin';
    }

    // Allow read access to anyone for club logos in the 'public' folder
    match /clubs/{clubId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && (isSiteAdmin(request.auth.uid) || isClubAdmin(request.auth.uid, clubId));
    }
    
    match /matches/{matchId}/{fileName} {
      allow read: if request.auth != null;
       allow write: if request.auth != null;
    }

    match /help_documents/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && isSiteAdmin(request.auth.uid);
    }
  }
}
