rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to get user role information from their token claims.
    // This is more secure and efficient than reading the user document during rule evaluation.
    function isSiteAdmin() {
      return request.auth.token.role == 'Site Admin';
    }

    function isClubAdmin(clubId) {
      // Check if the user's token claims them as a Club Admin for the specific clubId.
      return request.auth.token.role == 'Club Admin' && request.auth.token.primaryClubId == clubId;
    }

    // Users can read any user profile (for contact pages, etc.)
    // but can only write to their own document.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // Clubs can be read by anyone to populate lists, but only site admins can create/update/delete.
    match /clubs/{clubId} {
      allow read: if true;
      allow write: if isSiteAdmin();
    }
    
    // Series can be read by anyone. Writes are restricted to admins of the specific club.
    match /series/{seriesId} {
      allow read: if request.auth != null;
      allow write: if isSiteAdmin() || isClubAdmin(resource.data.clubId);
    }
    
    // Results can be read by anyone. Writes are restricted to admins of the specific club.
    // We ensure a result can only be created if the corresponding match exists.
    match /results/{resultId} {
      allow read: if request.auth != null;
      allow write: if (isSiteAdmin() || isClubAdmin(resource.data.clubId)) && exists(/databases/$(database)/documents/matches/$(request.resource.data.matchId));
    }

    // MATCHES: This is the critical fix.
    // READ: Any authenticated user can read match documents.
    // CREATE: Only a Site Admin or a Club Admin of that specific club can create a match.
    // UPDATE: Only a Site Admin or a Club Admin of that specific club can update a match.
    // DELETE: Only a Site Admin or a Club Admin of that specific club can delete a match.
    match /matches/{matchId} {
      allow read: if request.auth != null;
      allow create: if isSiteAdmin() || isClubAdmin(request.resource.data.clubId);
      allow update, delete: if isSiteAdmin() || isClubAdmin(resource.data.clubId);
    }
    
    // Help documents can be read by anyone, but only written by site admins.
    match /helpDocuments/{docId} {
      allow read: if true;
      allow write: if isSiteAdmin();
    }
    
    // Anyone can read public match data. No one can write directly.
    match /publicMatches/{matchId} {
      allow read: if true;
      allow write: if false; // Should be written via a trusted server/function
    }
    
    // Anyone can read public upcoming match data. No one can write directly.
    match /publicUpcomingMatches/{matchId} {
      allow read: if true;
      allow write: if false; // Should be written via a trusted server/function
    }
  }
}
